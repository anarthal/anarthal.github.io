<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Going async</title>
<link rel="stylesheet" href="../boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets Vsnapshot">
<link rel="home" href="../index.html" title="Chapter 1. Boost.Mysql">
<link rel="up" href="../index.html" title="Chapter 1. Boost.Mysql">
<link rel="prev" href="resultsets.html" title="Resultsets">
<link rel="next" href="ssl.html" title="SSL/TLS">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr><td valign="top"><img alt="Boost C++ Libraries" width="277" height="86" src="../images/proposed_for_boost.svg"></td></tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="resultsets.html"><img src="../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../images/home.png" alt="Home"></a><a accesskey="n" href="ssl.html"><img src="../images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="mysql.async"></a><a class="link" href="async.html" title="Going async">Going async</a>
</h2></div></div></div>
<p>
      Following <a class="ulink" href="https://www.boost.org/doc/libs/1_76_0/libs/asio/index.html" target="_top">Boost.Asio</a>'s convetion,
      all network operations have asynchronous versions with the same name prefixed
      by <code class="computeroutput"><span class="identifier">async_</span></code>. The last parameter
      to async operations is a <a class="ulink" href="https://www.boost.org/doc/libs/1_76_0/doc/html/boost_asio/reference/asynchronous_operations.html#boost_asio.reference.asynchronous_operations.completion_tokens_and_handlers" target="_top"><span class="emphasis"><em>CompletionToken</em></span></a>,
      which dictates how the asynchronous operation will be managed and the function's
      return type. These <code class="computeroutput"><span class="identifier">async_</span></code> functions
      are called async initiating functions.
    </p>
<p>
      Every async initiating function has an associated handler type, which dictates
      how the asynchronous operation communicates its result back to the caller.
      This handler type always has one of the two folling forms:
    </p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem">
          ) <code class="computeroutput"><span class="keyword">void</span><span class="special">(</span><span class="identifier">error_code</span><span class="special">)</span></code>.
          Used in operations that do not have a proper result, e.g. <a class="link" href="ref/boost__mysql__connection/async_connect.html" title="connection::async_connect"><code class="literal">connection::async_connect</code></a>.
        </li>
<li class="listitem">
          ) <code class="computeroutput"><span class="keyword">void</span><span class="special">(</span><span class="identifier">error_code</span><span class="special">,</span>
          <span class="identifier">T</span><span class="special">)</span></code>.
          Used in operations that have a result, e.g. <a class="link" href="ref/boost__mysql__connection/async_query.html" title="connection::async_query"><code class="literal">connection::async_query</code></a>
          (in this case, <code class="computeroutput"><span class="identifier">T</span></code> is <a class="link" href="ref/boost__mysql__resultset.html" title="resultset"><code class="literal">resultset&lt;Stream&gt;</code></a>).
        </li>
</ol></div>
<p>
      As noted <a class="link" href="error_handling.html" title="Error handling and available overloads">here</a>, all asynchronous
      are overloaded to accept an optional <a class="link" href="ref/boost__mysql__error_info.html" title="error_info"><code class="literal">error_info</code></a>
      output parameter, which is set before calling the completion handler, and is
      populated with diagnostic information, if available.
    </p>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.async.completion_tokens"></a><a class="link" href="async.html#mysql.async.completion_tokens" title="Completion tokens">Completion tokens</a>
</h3></div></div></div>
<p>
        The following completion tokens can be used in any asyncrhonous operation
        within <a class="ulink" href="https://anarthal.github.io/boost-mysql/index.html" target="_top">Boost.Mysql</a>:
      </p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p class="simpara">
            <span class="bold"><strong>Callbacks</strong></span>. You can pass in a callable
            (function pointer, function object) with the same signature as the handler
            signature specified for the operation. The handler will be called when
            the operation completes. The initiating function will return <code class="computeroutput"><span class="keyword">void</span></code>.
          </p>
<p class="simpara">
            <a class="link" href="examples/query_async_callbacks.html" title="Text query, async with callbacks">This example</a>
            demonstrates asynchronous text queries with callbacks.
          </p>
</li>
<li class="listitem">
<p class="simpara">
            <span class="bold"><strong>Futures</strong></span>. In this case, you pass in the
            constant <a class="ulink" href="https://www.boost.org/doc/libs/1_76_0/doc/html/boost_asio/reference/use_future.html" target="_top"><code class="literal">boost::asio::use_future</code></a>
            as completion token. The initiating function will return one of the following:
            <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; ">
<li class="listitem">
                  <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">future</span><span class="special">&lt;</span><span class="keyword">void</span><span class="special">&gt;</span></code>,
                  if the completion handler has the form given by 1).
                </li>
<li class="listitem">
                  <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">future</span><span class="special">&lt;</span><span class="identifier">T</span><span class="special">&gt;</span></code>,
                  if the completion handler has the form given by 2).
                </li>
</ul></div>
          </p>
<p class="simpara">
            You can wait for the future by calling <code class="computeroutput"><span class="identifier">future</span><span class="special">::</span><span class="identifier">get</span></code>.
            If an error occurs, <code class="computeroutput"><span class="identifier">future</span><span class="special">::</span><span class="identifier">get</span></code>
            will throw an exception. Note that the exception will <span class="bold"><strong>not</strong></span>
            contain the extra information stored in the <a class="link" href="ref/boost__mysql__error_info.html" title="error_info"><code class="literal">error_info</code></a>.
          </p>
<p class="simpara">
            <a class="link" href="examples/query_async_futures.html" title="Text query, async with futures">This example</a>
            demonstrates using futures with async queries.
          </p>
</li>
<li class="listitem">
<p class="simpara">
            <span class="bold"><strong><a class="ulink" href="https://www.boost.org/doc/libs/1_76_0/libs/coroutine/index.html" target="_top">Boost.Coroutine</a>
            coroutines</strong></span>. In this case, you pass in a <a class="ulink" href="https://www.boost.org/doc/libs/1_76_0/doc/html/boost_asio/reference/yield_context.html" target="_top"><code class="literal">boost::asio::yield_context</code></a>.
            To obtain one of these, you should use <a class="ulink" href="https://www.boost.org/doc/libs/1_76_0/doc/html/boost_asio/reference/spawn.html" target="_top"><code class="literal">boost::asio::spawn</code></a>
            to create a new coroutine. The initiating function will return:
            <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; ">
<li class="listitem">
                  <code class="computeroutput"><span class="keyword">void</span></code>, if the completion
                  handler has the form given by 1).
                </li>
<li class="listitem">
                  <code class="computeroutput"><span class="identifier">T</span></code>, if the completion
                  handler has the form given by 2).
                </li>
</ul></div>
          </p>
<p class="simpara">
            If you use <a class="ulink" href="https://www.boost.org/doc/libs/1_76_0/doc/html/boost_asio/reference/basic_yield_context/operator_lb__rb_.html" target="_top"><code class="literal">boost::asio::yield_context::operator[]</code></a>,
            the operation will set the given <a class="link" href="ref/boost__mysql__error_code.html" title="error_code"><code class="literal">error_code</code></a>
            when it fails. Otherwise, the function will throw a exception. Note that
            this exception will not contain the extra information stored in the
            <a class="link" href="ref/boost__mysql__error_info.html" title="error_info"><code class="literal">error_info</code></a>.
          </p>
<p class="simpara">
            <a class="link" href="examples/query_async_coroutines.html" title="Text query, async with Boost.Coroutine coroutines">This example</a>
            uses <a class="ulink" href="https://www.boost.org/doc/libs/1_76_0/libs/coroutine/index.html" target="_top">Boost.Coroutine</a>
            coroutines with async queries.
          </p>
</li>
<li class="listitem">
<p class="simpara">
            <span class="bold"><strong>C++20 coroutines</strong></span>. In this case, you
            pass in the constant <a class="ulink" href="https://www.boost.org/doc/libs/1_76_0/doc/html/boost_asio/reference/use_awaitable.html" target="_top"><code class="literal">boost::asio::use_awaitable</code></a>
            as completion token. The initiating function will return:
            <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; ">
<li class="listitem">
                  <code class="literal"><a class="ulink" href="https://www.boost.org/doc/libs/1_76_0/doc/html/boost_asio/reference/awaitable.html" target="_top"><code class="literal">boost::asio::awaitable&lt;void&gt;</code></a></code>,
                  if the completion handler has the form given by 1).
                </li>
<li class="listitem">
                  <code class="literal"><a class="ulink" href="https://www.boost.org/doc/libs/1_76_0/doc/html/boost_asio/reference/awaitable.html" target="_top"><code class="literal">boost::asio::awaitable&lt;T&gt;</code></a></code>,
                  if the completion handler has the form given by 2).
                </li>
</ul></div>
          </p>
<p class="simpara">
            You can then use <code class="computeroutput"><span class="identifier">co_await</span></code>
            on this return value. If the operation fails, <code class="computeroutput"><span class="identifier">co_await</span></code>
            will throw an exception. Note that this exception will not contain the
            extra information stored in the <a class="link" href="ref/boost__mysql__error_info.html" title="error_info"><code class="literal">error_info</code></a>.
          </p>
<p class="simpara">
            <a class="link" href="examples/query_async_coroutinescpp20.html" title="Text query, async with C++20 coroutines">This example</a>
            demonstrates using C++20 coroutines to perform text queries.
          </p>
</li>
</ul></div>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.async.default_completion_tokens"></a><a class="link" href="async.html#mysql.async.default_completion_tokens" title="Default completion tokens">Default completion
      tokens</a>
</h3></div></div></div>
<p>
        <a class="ulink" href="https://anarthal.github.io/boost-mysql/index.html" target="_top">Boost.Mysql</a>
        also supports default completion tokens. Recall that some stream types may
        have an associated <a class="ulink" href="https://www.boost.org/doc/libs/1_76_0/doc/html/boost_asio/reference/Executor1.html" target="_top"><span class="emphasis"><em>Executor</em></span></a>
        that has an associated default completion token type (see [asiolinkref default_completion_token
        default_completion_token]). If this is the case, you don't need to specify
        the <a class="ulink" href="https://www.boost.org/doc/libs/1_76_0/doc/html/boost_asio/reference/asynchronous_operations.html#boost_asio.reference.asynchronous_operations.completion_tokens_and_handlers" target="_top"><span class="emphasis"><em>CompletionToken</em></span></a>
        parameter in initiating functions, and the default will be used. <a class="link" href="examples/default_completion_tokens.html" title="Default completion tokens">This
        example</a> demonstrates using default completion tokens with <a class="ulink" href="https://anarthal.github.io/boost-mysql/index.html" target="_top">Boost.Mysql</a>.
      </p>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.async.sequencing"></a><a class="link" href="async.html#mysql.async.sequencing" title="Sequencing of operations">Sequencing of operations</a>
</h3></div></div></div>
<p>
        The MySQL client-server protocol is strictly sequential. Every operation
        is initiated by the client, and the server will reply to it with a certain
        number of response packets. Once a given operation has begun, it must run
        until its completion before initiating another one. Otherwise, the results
        are undefined.
      </p>
<p>
        This means that, when using async operations, the user must ensure that no
        network operation is triggered before the previous one finishes. For example,
        it is illegal to call <a class="link" href="ref/boost__mysql__connection/async_query.html" title="connection::async_query"><code class="literal">connection::async_query</code></a>
        while you have an outstanding <a class="link" href="ref/boost__mysql__connection/async_prepare_statement.html" title="connection::async_prepare_statement"><code class="literal">connection::async_prepare_statement</code></a>
        (one that hasn't completed yet).
      </p>
<p>
        Reading resultsets is a particularly sensitive case of the above. For the
        server, an <a class="link" href="ref/boost__mysql__connection/async_query.html" title="connection::async_query"><code class="literal">connection::async_query</code></a>
        or <a class="link" href="ref/boost__mysql__prepared_statement/async_execute.html" title="prepared_statement::async_execute"><code class="literal">prepared_statement::async_execute</code></a>
        is considered complete after all rows in the originated resultset are sent
        (as detailed <a class="link" href="resultsets.html#mysql.resultsets.server_send" title="When does the server send the rows?">here</a>). This
        means that after calling any of these methods and before the resultset is
        read until being complete, the connection is still considered to be engaged
        in a network operation. This is the reason why every single row in a resultset
        must be read before engaing in any other operation.
      </p>
<div class="note"><table border="0" summary="Note">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="../images/note.png"></td>
<th align="left">Note</th>
</tr>
<tr><td align="left" valign="top"><p>
          These considerations apply on a per-connection basis. You can safely engage
          in paralel operations if you use different connections.
        </p></td></tr>
</table></div>
</div>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer"></div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="resultsets.html"><img src="../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../images/home.png" alt="Home"></a><a accesskey="n" href="ssl.html"><img src="../images/next.png" alt="Next"></a>
</div>
</body>
</html>
